<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>AFL Player Stats Tool</title>
    <style>
      table {
        border-collapse: collapse;
      }

      td,
      th {
        border: 1px solid black;
        padding: 5px;
        text-align: center; /* Centers content horizontally */
        vertical-align: middle; /* Centers content vertically */
      }
    </style>
  </head>

  <body>
    <form id="statsForm" onsubmit="return validateUserInput();">
      <label>
        Player Name:
        <input type="text" name="playerName" value="Shai Bolton" required />
      </label>
      <br />

      <label>
        Number of Disposals:
        <input
          type="number"
          step="0.5"
          min="0.5"
          name="numDisposals"
          value="14.5"
          pattern="^[0-9]*\.5$"
          required
        />
      </label>
      <small>Disposal number must end in .5 (e.g. 14.5)</small>
      <br />

      <label>
        Number of Goals:
        <input
          type="number"
          step="0.5"
          min="0.5"
          name="numGoals"
          value="0.5"
          pattern="^[0-9]*\.5$"
          required
        />
      </label>
      <small>Goal number must end in .5 (e.g. 1.5)</small>
      <br />

      <label>
        Last N Matches:
        <input
          type="text"
          name="lastNMatches"
          pattern="All|^[1-9][0-9]*$"
          value="All"
          required
        />
      </label>
      <small>Enter 'All' or a whole number above 0</small>
      <br />

      <label>
        Home/Away:
        <select name="homeAway">
          <option value="Any" selected>Any</option>
          <option value="Home">Home</option>
          <option value="Away">Away</option>
        </select>
      </label>
      <br />

      <label>
        Win/Loss:
        <select name="winLoss">
          <option value="Any" selected>Any</option>
          <option value="Win">Win</option>
          <option value="Loss">Loss</option>
        </select>
      </label>
      <br />

      <label>
        Opponent Team:
        <select name="opponentTeam">
          <option value="All" selected>All</option>
          <option value="Adelaide">Adelaide</option>
          <option value="Brisbane Lions">Brisbane Lions</option>
          <option value="Carlton">Carlton</option>
          <option value="Collingwood">Collingwood</option>
          <option value="Essendon">Essendon</option>
          <option value="Fremantle">Fremantle</option>
          <option value="Geelong">Geelong</option>
          <option value="Gold Coast">Gold Coast</option>
          <option value="Greater Western Sydney">Greater Western Sydney</option>
          <option value="Hawthorn">Hawthorn</option>
          <option value="Melbourne">Melbourne</option>
          <option value="North Melbourne">North Melbourne</option>
          <option value="Port Adelaide">Port Adelaide</option>
          <option value="Richmond">Richmond</option>
          <option value="St Kilda">St Kilda</option>
          <option value="Sydney">Sydney</option>
          <option value="West Coast">West Coast</option>
          <option value="Western Bulldogs">Western Bulldogs</option>
        </select>
      </label>
      <br />

      <label>
        Most Recent Team:
        <select name="mostRecentTeam">
          <option value="Yes" selected>Yes</option>
          <option value="No">No</option>
        </select>
      </label>
      <br />

      <input type="hidden" name="action" value="processStats" />
      <input type="submit" value="Submit" />
    </form>

    <div id="output"></div>

    <script>
      document
        .querySelector("#statsForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          var formData = new FormData(e.target);
          var params = new URLSearchParams(formData).toString();

          fetch(
            "https://script.google.com/macros/s/AKfycbxe2RCW81zjzM6SNTfkeduzTvXkF4sLT7G9F6-Omc6_ATp00_ckp6T6fhPmz71cC2MVnQ/exec?" +
              params,
            {
              method: "GET",
              mode: "cors",
            },
          )
            .then((response) => response.json())
            .then((data) => displayResults(data))
            .catch((error) => {
              console.error("Error:", error);
            });
        });

      function validateUserInput() {
        const disposalInput = parseFloat(
          document.querySelector('[name="numDisposals"]').value,
        );
        const goalInput = parseFloat(
          document.querySelector('[name="numGoals"]').value,
        );

        if (disposalInput % 1 !== 0.5) {
          alert("Error: number of disposals must end in .5");
          return false; // Prevent form submission
        }

        if (goalInput % 1 !== 0.5) {
          alert("Error: number of goals must end in .5");
          return false; // Prevent form submission
        }

        return true;
      }

      function displayResults(data) {
        var outputDiv = document.getElementById("output");

        var tableHTML = "<h2>" + data.header + "</h2>";
        tableHTML +=
          '<table border="1" cellspacing="0" cellpadding="5" style="width:auto;">';

        data.stats.forEach(function (row, rowIndex) {
          tableHTML += "<tr>";
          if (
            rowIndex === data.stats.length - 1 &&
            row[0] &&
            !row[1] &&
            !row[2]
          ) {
            var formattedCell = row[0].replace(/\n/g, "<br>");
            tableHTML += '<td colspan="3">' + formattedCell + "</td>";
          } else {
            row.forEach(function (cell) {
              var formattedCell = (cell || "").replace(/\n/g, "<br>");
              tableHTML += "<td>" + formattedCell + "</td>";
            });
          }
          tableHTML += "</tr>";
        });

        tableHTML += "</table>";

        outputDiv.innerHTML = tableHTML;
      }
    </script>
  </body>
</html>
