<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1" />
    <title>AFL Player Stats Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 600px;
            width: 100%;
            padding: 20px;
            border: 1px solid #eaeaea;
            border-radius: 8px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }

        label {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #007BFF;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }

        input[type="submit"] {
            background-color: #007BFF;
            color: #ffffff;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        input[type="submit"]:hover {
            background-color: #0056b3;
        }

        small {
            font-size: 0.8rem;
            color: gray;
        }

        #output {
            max-width: 95%;
            overflow-x: auto;
        }

        @media (max-width: 480px) {
            form {
                gap: 10px;
            }

            label {
                font-size: 0.9rem;
            }
        }

        table {
            border-collapse: collapse;
        }

        td, th {
            border: 1px solid black;
            padding: 5px;
            text-align: center;
            vertical-align: middle;
        }
    </style>
</head>

<body>
    <form id="statsForm" onsubmit="return validateUserInput();">
        <fieldset>
            <legend>Player Details</legend>
            <label>
                Player Name:
                <input type="text" name="playerName" placeholder="Shai Bolton" required />
            </label>

            <label>
                Number of Disposals:
                <input type="number" step="0.5" min="0.5" name="numDisposals" placeholder="14.5" pattern="^[0-9]*\.5$" required />
                <small>Disposal number must end in .5 (e.g. 14.5)</small>
            </label>

            <label>
                Number of Goals:
                <input type="number" step="0.5" min="0.5" name="numGoals" placeholder="0.5" pattern="^[0-9]*\.5$" required />
                <small>Goal number must end in .5 (e.g. 1.5)</small>
            </label>

            <label>
                Last N Matches:
                <input type="text" name="lastNMatches" pattern="All|^[1-9][0-9]*$" placeholder="All" required />
                <small>Enter 'All' or a whole number above 0</small>
            </label>
        </fieldset>

        <fieldset>
            <legend>Match Details</legend>
            <label>
                Home/Away:
                <select name="homeAway">
                    <option value="Any" selected>Any</option>
                    <option value="Home">Home</option>
                    <option value="Away">Away</option>
                </select>
            </label>

            <label>
                Win/Loss:
                <select name="winLoss">
                    <option value="Any" selected>Any</option>
                    <option value="Win">Win</option>
                    <option value="Loss">Loss</option>
                </select>
            </label>

            <label>
                Opponent Team:
                <select name="opponentTeam">
                    <option value="All" selected>All</option>
                    <!-- Truncated for brevity -->
                </select>
            </label>

            <label>
                Most Recent Team:
                <select name="mostRecentTeam">
                    <option value="Yes" selected>Yes</option>
                    <option value="No">No</option>
                </select>
            </label>
        </fieldset>

        <input type="hidden" name="action" value="processStats" />
        <input type="submit" value="Submit" />
    </form>

    <div id="output"></div>

    <script>
      document
        .querySelector("#statsForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          var formData = new FormData(e.target);
          var params = new URLSearchParams(formData).toString();

          fetch(
            "https://script.google.com/macros/s/AKfycbxe2RCW81zjzM6SNTfkeduzTvXkF4sLT7G9F6-Omc6_ATp00_ckp6T6fhPmz71cC2MVnQ/exec?" +
              params,
            {
              method: "GET",
              mode: "cors",
            },
          )
            .then((response) => response.json())
            .then((data) => displayResults(data))
            .catch((error) => {
              console.error("Error:", error);
            });
        });

      function validateUserInput() {
        const disposalInput = parseFloat(
          document.querySelector('[name="numDisposals"]').value,
        );
        const goalInput = parseFloat(
          document.querySelector('[name="numGoals"]').value,
        );

        if (disposalInput % 1 !== 0.5) {
          alert("Error: number of disposals must end in .5");
          return false; // Prevent form submission
        }

        if (goalInput % 1 !== 0.5) {
          alert("Error: number of goals must end in .5");
          return false; // Prevent form submission
        }

        return true;
      }

function displayResults(data) {
    const outputDiv = document.getElementById("output");
    
    // Clear previous results
    outputDiv.innerHTML = '';

    // Create an H2 element for the header
    const header = document.createElement('h2');
    header.textContent = data.header;
    outputDiv.appendChild(header);

    // Create the table with necessary classes
    const table = document.createElement('table');
    table.classList.add("responsive-table");

    data.stats.forEach((row, rowIndex) => {
        const tr = document.createElement('tr');
        
        if (
            rowIndex === data.stats.length - 1 &&
            row[0] &&
            !row[1] &&
            !row[2]
        ) {
            const td = document.createElement('td');
            td.setAttribute('colspan', '3');
            td.innerHTML = row[0].replace(/\n/g, "<br>"); // Assuming that this content is safe from XSS
            tr.appendChild(td);
        } else {
            row.forEach((cell) => {
                const td = document.createElement('td');
                td.textContent = cell;  // This ensures that the content is safely added
                tr.appendChild(td);
            });
        }
        
        table.appendChild(tr);
    });

    outputDiv.appendChild(table);
}

    </script>
  </body>
</html>
